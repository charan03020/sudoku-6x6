<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Ranks - Sudoku 6</title>
    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #090a0f; }
        
        /* The Glass Leaderboard Card */
        .rank-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(25px) saturate(150%);
            -webkit-backdrop-filter: blur(25px) saturate(150%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 30px;
            border-radius: 30px;
            width: 95%;
            max-width: 450px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.8s ease-out;
        }

        table { width: 100%; border-collapse: collapse; color: white; margin-top: 10px; }
        th { 
            text-align: center; 
            padding: 15px; 
            text-transform: uppercase; 
            font-size: 0.75rem; 
            letter-spacing: 2px;
            color: #0a66c2;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        td { padding: 15px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }

        /* Highlight the current player */
        .me-row { 
            background: rgba(10, 102, 194, 0.2); 
            border-radius: 15px;
            color: #00acee !important;
            font-weight: bold;
        }

        .gold { color: #ffd700; font-weight: bold; }
        .silver { color: #c0c0c0; }
        .bronze { color: #cd7f32; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -45%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }

        #bgCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
    </style>
</head>
<body>

<canvas id="bgCanvas"></canvas>

<div class="center-box">
    <div class="rank-card">
        <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 20px;">
            <i class="fa fa-globe" style="color: #0a66c2; font-size: 1.5rem;"></i>
            <h2 style="color: white; margin: 0; letter-spacing: 2px;">GLOBAL RANKS</h2>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Player</th>
                    <th>Coins</th>
                </tr>
            </thead>
            <tbody id="realtimeBody">
                <tr>
                    <td colspan="3" style="opacity: 0.5; padding: 40px;">
                        <i class="fa fa-spinner fa-spin"></i> Connecting to Global Server...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <br>
    <button class="start-btn" onclick="window.location.href='main.html'" style="padding: 12px 40px; font-size: 1rem;">
        <i class="fa fa-arrow-left"></i> BACK
    </button>
</div>

<script src="motion.js"></script>

<script>
    // 1. Connection Config
    const firebaseConfig = {
        databaseURL: "https://sudokugame6x6-default-rtdb.firebaseio.com/" 
    };

    // 2. Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 3. Get Local User Info
    let myName = localStorage.getItem("gamerName") || "Player_" + Math.floor(Math.random() * 1000);
    let myCoins = parseInt(localStorage.getItem("coins")) || 0;

    /**
     * SYNC DATA TO CLOUD
     */
    function syncMyScore() {
        db.ref('players/' + myName).set({
            username: myName,
            coins: myCoins,
            lastSeen: Date.now()
        });
    }

    /**
     * LISTEN FOR ALL PLAYERS (LIVE)
     */
    function startLiveUpdates() {
        const tbody = document.getElementById("realtimeBody");

        // Listener: Runs every time anyone in the world updates
        db.ref('players').orderByChild('coins').on('value', (snapshot) => {
            let players = [];
            snapshot.forEach((child) => {
                players.push(child.val());
            });

            // Sort Descending (Highest coins first)
            players.sort((a, b) => b.coins - a.coins);

            tbody.innerHTML = ""; // Clear table

            players.forEach((player, index) => {
                const isMe = player.username === myName;
                const rank = index + 1;
                
                // Styling for Top 3
                let rankStyle = "";
                if (rank === 1) rankStyle = "gold";
                else if (rank === 2) rankStyle = "silver";
                else if (rank === 3) rankStyle = "bronze";

                const row = `
                    <tr class="${isMe ? 'me-row' : ''}">
                        <td class="${rankStyle}">#${rank}</td>
                        <td style="text-align: left; padding-left: 20px;">
                            ${player.username} ${isMe ? '<small>(YOU)</small>' : ''}
                        </td>
                        <td style="color: #ffd700; font-weight: bold;">${player.coins}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        });
    }

    // Run functions
    syncMyScore();
    startLiveUpdates();
</script>

</body>
</html>